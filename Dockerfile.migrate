FROM node:20-alpine
RUN apk add --no-cache libc6-compat openssl
WORKDIR /app
COPY package.json ./
RUN npm install
COPY prisma ./prisma
COPY . .
RUN npx prisma generate
CMD npx prisma db push --skip-generate 2>&1 || echo "prisma db push warning (non-fatal, ensure-columns will handle)" && \
    echo "Ensuring columns exist..." && \
    node prisma/ensure-columns.js && \
    echo "Validating schema..." && \
    node prisma/validate-schema.js && \
    npx tsx prisma/seed.ts
