FROM node:20-alpine
RUN apk add --no-cache libc6-compat openssl
WORKDIR /app
COPY package.json ./
RUN npm install
COPY prisma ./prisma
COPY . .
RUN npx prisma generate
CMD set -e && \
    echo "=== Migration: ensure-columns (safe, additive only) ===" && \
    node prisma/ensure-columns.js && \
    echo "=== Migration: validate schema ===" && \
    node prisma/validate-schema.js && \
    echo "=== Migration: seed ===" && \
    npx tsx prisma/seed.ts
